name: Client Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Build shared TypeScript packages once
  build-ts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install
      - run: pnpm build
      - uses: actions/upload-artifact@v4
        with:
          name: ts-build
          path: |
            packages/*/dist
            node_modules/.pnpm
          retention-days: 1

  # Parallel conformance tests by client
  conformance:
    needs: build-ts
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        client:
          - name: typescript
            cmd: ts
            setup: ""
          - name: go
            cmd: ../../packages/client-go/conformance-adapter
            setup: |
              cd packages/client-go
              go build -o conformance-adapter ./cmd/conformance-adapter
          - name: dotnet
            cmd: ../../packages/client-dotnet/adapter/conformance-adapter
            setup: |
              cd packages/client-dotnet
              dotnet publish src/DurableStreams.ConformanceAdapter -c Release -o ./adapter
          - name: swift
            cmd: ../client-swift/run-conformance-adapter.sh
            setup: |
              cd packages/client-swift
              swift build -c release
          - name: php
            cmd: ../client-php/run-conformance-adapter.sh
            setup: |
              cd packages/client-php
              composer install --no-interaction
              composer analyse
          - name: java
            cmd: ../client-java/run-conformance-adapter.sh
            setup: |
              cd packages/client-java
              ./gradlew build
          - name: rust
            cmd: ../client-rust/run-conformance-adapter.sh
            setup: |
              cd packages/client-rust
              cargo build --release
          - name: ruby
            cmd: ../client-rb/run-conformance-adapter.sh
            setup: ""
    name: conformance (${{ matrix.client.name }})
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      # Language-specific setup
      - if: matrix.client.name == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: packages/client-go/go.mod

      - if: matrix.client.name == 'dotnet'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0"

      - if: matrix.client.name == 'swift'
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0"

      - if: matrix.client.name == 'php'
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - if: matrix.client.name == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - if: matrix.client.name == 'rust'
        uses: dtolnay/rust-toolchain@stable
      - if: matrix.client.name == 'rust'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/client-rust

      - if: matrix.client.name == 'ruby'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true
          working-directory: packages/client-rb

      - run: pnpm install
      - uses: actions/download-artifact@v4
        with:
          name: ts-build

      # Build client adapter
      - if: matrix.client.setup != ''
        run: ${{ matrix.client.setup }}

      # Run conformance tests
      - name: Run ${{ matrix.client.name }} conformance tests
        run: |
          cd packages/client-conformance-tests
          pnpm tsx src/cli.ts --run ${{ matrix.client.cmd }}

  # Elixir conformance (separate due to Erlang/OTP setup)
  conformance-elixir:
    needs: build-ts
    runs-on: ubuntu-latest
    name: conformance (elixir)
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.18"
          otp-version: "27"

      - run: pnpm install
      - uses: actions/download-artifact@v4
        with:
          name: ts-build

      - name: Build Elixir client adapter
        run: |
          cd packages/client-elixir
          mix local.hex --force
          mix local.rebar --force
          mix deps.get
          mix compile
          mix escript.build

      - name: Run Elixir conformance tests
        run: |
          cd packages/client-conformance-tests
          pnpm tsx src/cli.ts --run ../client-elixir/run-conformance-adapter.sh

  # Parallel benchmarks by client
  benchmark:
    needs: build-ts
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        client:
          - name: typescript
            id: ts
            cmd: ts
            setup: ""
          - name: go
            id: go
            cmd: ../../packages/client-go/conformance-adapter
            setup: |
              cd packages/client-go
              go build -o conformance-adapter ./cmd/conformance-adapter
          - name: python
            id: py
            cmd: ../client-py/run-conformance-adapter.sh
            setup: |
              cd packages/client-py
              uv sync
          - name: dotnet
            id: dotnet
            cmd: ../../packages/client-dotnet/adapter/conformance-adapter
            setup: |
              cd packages/client-dotnet
              dotnet publish src/DurableStreams.ConformanceAdapter -c Release -o ./adapter
          - name: swift
            id: swift
            cmd: ../client-swift/run-conformance-adapter.sh
            setup: |
              cd packages/client-swift
              swift build -c release
          - name: php
            id: php
            cmd: ../client-php/run-conformance-adapter.sh
            setup: |
              cd packages/client-php
              composer install --no-interaction
          - name: java
            id: java
            cmd: ../client-java/run-conformance-adapter.sh
            setup: |
              cd packages/client-java
              ./gradlew build
          - name: rust
            id: rust
            cmd: ../client-rust/run-conformance-adapter.sh
            setup: |
              cd packages/client-rust
              cargo build --release
          - name: ruby
            id: rb
            cmd: ../client-rb/run-conformance-adapter.sh
            setup: ""
    name: benchmark (${{ matrix.client.name }})
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      # Language-specific setup
      - if: matrix.client.name == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: packages/client-go/go.mod

      - if: matrix.client.name == 'python'
        uses: astral-sh/setup-uv@v4
      - if: matrix.client.name == 'python'
        run: uv python install 3.12

      - if: matrix.client.name == 'dotnet'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0"

      - if: matrix.client.name == 'swift'
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0"

      - if: matrix.client.name == 'php'
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - if: matrix.client.name == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - if: matrix.client.name == 'rust'
        uses: dtolnay/rust-toolchain@stable
      - if: matrix.client.name == 'rust'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/client-rust

      - if: matrix.client.name == 'ruby'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true
          working-directory: packages/client-rb

      - run: pnpm install
      - uses: actions/download-artifact@v4
        with:
          name: ts-build

      # Build client adapter
      - if: matrix.client.setup != ''
        run: ${{ matrix.client.setup }}

      # Run benchmarks
      - name: Run ${{ matrix.client.name }} benchmarks
        id: bench
        continue-on-error: true
        run: |
          cd packages/client-conformance-tests
          pnpm tsx src/cli.ts --bench ${{ matrix.client.cmd }} --format json > benchmark-results.json
          cat benchmark-results.json

          PASSED=$(jq -r '.passed // 0' benchmark-results.json)
          FAILED=$(jq -r '.failed // 0' benchmark-results.json)
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-${{ matrix.client.id }}
          path: packages/client-conformance-tests/benchmark-results.json

  # Elixir benchmark (separate due to Erlang/OTP setup)
  benchmark-elixir:
    needs: build-ts
    runs-on: ubuntu-latest
    name: benchmark (elixir)
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.18"
          otp-version: "27"

      - run: pnpm install
      - uses: actions/download-artifact@v4
        with:
          name: ts-build

      - name: Build Elixir client adapter
        run: |
          cd packages/client-elixir
          mix local.hex --force
          mix local.rebar --force
          mix deps.get
          mix compile
          mix escript.build

      - name: Run Elixir benchmarks
        id: bench
        continue-on-error: true
        run: |
          cd packages/client-conformance-tests
          pnpm tsx src/cli.ts --bench ../client-elixir/run-conformance-adapter.sh --format json > benchmark-results.json
          cat benchmark-results.json

          PASSED=$(jq -r '.passed // 0' benchmark-results.json)
          FAILED=$(jq -r '.failed // 0' benchmark-results.json)
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-elixir
          path: packages/client-conformance-tests/benchmark-results.json

  # Aggregate benchmark results and post PR comment
  benchmark-report:
    needs: [benchmark, benchmark-elixir]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install
      - run: pnpm build

      - uses: actions/download-artifact@v4
        with:
          pattern: benchmark-*
          path: benchmark-results
          merge-multiple: false

      - name: Generate benchmark report
        run: |
          cd packages/client-conformance-tests
          # Aggregate all benchmark results from downloaded artifacts
          pnpm tsx src/cli.ts --report ../../benchmark-results > benchmark-report.md
          cat benchmark-report.md

      - name: Comment on PR with benchmark results
        # Skip for fork PRs - GITHUB_TOKEN doesn't have write access for security reasons
        if: always() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('packages/client-conformance-tests/benchmark-report.md', 'utf8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Client Benchmark Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report,
              });
            }
