<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Durable Streams - Browser Input Workflow</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem;
        color: #2d3748;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 2rem;
        color: white;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .workflow-card {
        background: white;
        padding: 2rem;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      }

      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
      }

      .status-badge.waiting {
        background: #fef3c7;
        color: #92400e;
      }

      .status-badge.connected {
        background: #d1fae5;
        color: #065f46;
      }

      .status-badge.completed {
        background: #dbeafe;
        color: #1e40af;
      }

      .prompt-text {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 1.5rem;
      }

      .input-group {
        margin-bottom: 1rem;
      }

      .input-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #4a5568;
      }

      .input-group input[type="text"],
      .input-group input[type="email"] {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 1rem 0;
        padding: 0.75rem;
        background: #f7fafc;
        border-radius: 8px;
        cursor: pointer;
      }

      .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .checkbox-group label {
        cursor: pointer;
        color: #4a5568;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.875rem 2rem;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        width: 100%;
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .loading-state {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        background: #eef2ff;
        border-radius: 12px;
      }

      .spinner {
        width: 28px;
        height: 28px;
        border: 3px solid #e2e8f0;
        border-radius: 50%;
        border-top-color: #667eea;
        animation: spin 1s linear infinite;
        flex-shrink: 0;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .output-message {
        padding: 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        font-size: 1.1rem;
        text-align: center;
      }

      .output-message .checkmark {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
      }

      .waiting-state {
        text-align: center;
        padding: 2rem;
        color: #718096;
      }

      .waiting-state .icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .event-log {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e2e8f0;
      }

      .event-log h3 {
        font-size: 0.9rem;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
      }

      .event-list {
        font-family: "Courier New", monospace;
        font-size: 0.85rem;
        background: #f7fafc;
        border-radius: 8px;
        padding: 1rem;
        max-height: 200px;
        overflow-y: auto;
      }

      .event-item {
        padding: 0.25rem 0;
        color: #4a5568;
      }

      .event-item.input_request {
        color: #667eea;
      }

      .event-item.input_response {
        color: #10b981;
      }

      .event-item.loading {
        color: #f59e0b;
      }

      .event-item.output {
        color: #8b5cf6;
      }

      .connection-error {
        padding: 1.5rem;
        background: #fee2e2;
        border-left: 4px solid #dc2626;
        border-radius: 8px;
        color: #991b1b;
      }

      .loading-overlay {
        text-align: center;
        padding: 3rem;
        color: white;
      }

      .loading-overlay .spinner {
        width: 40px;
        height: 40px;
        margin: 0 auto 1rem;
        border-color: rgba(255, 255, 255, 0.3);
        border-top-color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Await Browser Input</h1>
        <p>Server workflow blocking on browser input</p>
      </div>

      <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <div>Connecting to stream...</div>
      </div>

      <div id="app" style="display: none">
        <div class="workflow-card">
          <div id="content"></div>

          <div class="event-log">
            <h3>Event Log</h3>
            <div class="event-list" id="eventLog"></div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { DurableStream } from "@durable-streams/client"
      import { createStreamDB, createStateSchema } from "@durable-streams/state"
      import { z } from "zod"

      const SERVER_URL = "http://localhost:4437"
      const STREAM_PATH = "/browser-input-workflow"

      // Same schema as server
      const workflowEventSchema = z.discriminatedUnion("kind", [
        z.object({
          kind: z.literal("input_request"),
          requestId: z.string(),
          prompt: z.string(),
          fields: z
            .record(
              z.object({
                type: z.enum(["text", "email", "checkbox"]),
                label: z.string(),
              })
            )
            .optional(),
        }),
        z.object({
          kind: z.literal("input_response"),
          requestId: z.string(),
          value: z.unknown(),
        }),
        z.object({
          kind: z.literal("loading"),
          message: z.string(),
        }),
        z.object({
          kind: z.literal("output"),
          message: z.string(),
        }),
        z.object({
          kind: z.literal("complete"),
        }),
      ])

      const stateSchema = createStateSchema({
        events: {
          schema: workflowEventSchema,
          type: "event",
          primaryKey: (e) =>
            e.kind === "input_request" || e.kind === "input_response"
              ? `${e.kind}-${e.requestId}`
              : `${e.kind}-${Date.now()}-${Math.random()}`,
        },
      })

      let db
      const eventLog = []

      function addToLog(event) {
        eventLog.push(event)
        renderEventLog()
      }

      function renderEventLog() {
        const logEl = document.getElementById("eventLog")
        logEl.innerHTML = eventLog
          .map(
            (e) =>
              `<div class="event-item ${e.kind}">${e.kind}: ${JSON.stringify(e).slice(0, 80)}...</div>`
          )
          .join("")
        logEl.scrollTop = logEl.scrollHeight
      }

      async function init() {
        const streamUrl = `${SERVER_URL}/v1/stream${STREAM_PATH}`

        try {
          // Wait for stream to exist (server creates it)
          let streamExists = false
          let attempts = 0
          while (!streamExists && attempts < 30) {
            try {
              const testStream = new DurableStream({ url: streamUrl })
              await testStream.head()
              streamExists = true
            } catch {
              attempts++
              await new Promise((r) => setTimeout(r, 1000))
              document.getElementById("loading").innerHTML = `
                <div class="spinner"></div>
                <div>Waiting for server workflow to start... (${attempts}s)</div>
                <div style="font-size: 0.9rem; margin-top: 1rem; opacity: 0.8;">
                  Run: pnpm run workflow
                </div>
              `
            }
          }

          if (!streamExists) {
            throw new Error("Server workflow not started. Run: pnpm run workflow")
          }

          db = createStreamDB({
            streamOptions: {
              url: streamUrl,
              contentType: "application/json",
            },
            state: stateSchema,
          })

          await db.preload()

          // Subscribe to changes
          db.collections.events.subscribeChanges(() => {
            render()
          })

          document.getElementById("loading").style.display = "none"
          document.getElementById("app").style.display = "block"

          render()
        } catch (err) {
          document.getElementById("loading").innerHTML = `
            <div class="connection-error">
              <strong>Connection Error</strong><br><br>
              ${err.message}<br><br>
              Make sure:<br>
              1. Durable Streams server is running on ${SERVER_URL}<br>
              2. Server workflow is started: <code>pnpm run workflow</code>
            </div>
          `
        }
      }

      function getLatestState() {
        const events = Array.from(db.collections.events.values())

        // Find unanswered input requests
        const inputRequests = events.filter((e) => e.kind === "input_request")
        const inputResponses = events.filter((e) => e.kind === "input_response")
        const respondedIds = new Set(inputResponses.map((r) => r.requestId))

        const pendingRequest = inputRequests.find(
          (req) => !respondedIds.has(req.requestId)
        )

        // Find latest loading/output/complete
        const loadingEvents = events.filter((e) => e.kind === "loading")
        const outputEvents = events.filter((e) => e.kind === "output")
        const completeEvents = events.filter((e) => e.kind === "complete")

        return {
          events,
          pendingRequest,
          latestLoading: loadingEvents[loadingEvents.length - 1],
          latestOutput: outputEvents[outputEvents.length - 1],
          isComplete: completeEvents.length > 0,
        }
      }

      async function submitResponse(requestId, value) {
        await db.stream.append(
          stateSchema.events.insert({
            value: {
              kind: "input_response",
              requestId,
              value,
            },
          })
        )
      }

      function render() {
        const content = document.getElementById("content")
        const state = getLatestState()

        // Update event log
        eventLog.length = 0
        state.events.forEach((e) => eventLog.push(e))
        renderEventLog()

        // Workflow complete
        if (state.isComplete) {
          content.innerHTML = `
            <span class="status-badge completed">Workflow Complete</span>
            ${
              state.latestOutput
                ? `
              <div class="output-message">
                <div class="checkmark">✓</div>
                ${state.latestOutput.message}
              </div>
            `
                : ""
            }
          `
          return
        }

        // Show loading state if no pending request
        if (!state.pendingRequest && state.latestLoading) {
          content.innerHTML = `
            <span class="status-badge connected">Connected</span>
            <div class="loading-state">
              <div class="spinner"></div>
              <span>${state.latestLoading.message}</span>
            </div>
          `
          return
        }

        // Show pending input request
        if (state.pendingRequest) {
          const req = state.pendingRequest
          const hasFields = req.fields && Object.keys(req.fields).length > 0

          if (hasFields) {
            // Multi-field input
            const fieldHtml = Object.entries(req.fields)
              .map(([name, field]) => {
                if (field.type === "checkbox") {
                  return `
                    <div class="checkbox-group">
                      <input type="checkbox" id="field-${name}" name="${name}" />
                      <label for="field-${name}">${field.label}</label>
                    </div>
                  `
                }
                return `
                  <div class="input-group">
                    <label for="field-${name}">${field.label}</label>
                    <input type="${field.type}" id="field-${name}" name="${name}" />
                  </div>
                `
              })
              .join("")

            content.innerHTML = `
              <span class="status-badge connected">Awaiting Input</span>
              <div class="prompt-text">${req.prompt}</div>
              <form id="inputForm">
                ${fieldHtml}
                <button type="submit">Continue</button>
              </form>
            `

            document.getElementById("inputForm").addEventListener("submit", async (e) => {
              e.preventDefault()
              const btn = e.target.querySelector("button")
              btn.disabled = true
              btn.textContent = "Sending..."

              const values = {}
              for (const [name, field] of Object.entries(req.fields)) {
                const input = document.getElementById(`field-${name}`)
                values[name] =
                  field.type === "checkbox" ? input.checked : input.value
              }

              await submitResponse(req.requestId, values)
            })
          } else {
            // Simple text input
            content.innerHTML = `
              <span class="status-badge connected">Awaiting Input</span>
              <div class="prompt-text">${req.prompt}</div>
              <form id="inputForm">
                <div class="input-group">
                  <input type="text" id="simpleInput" placeholder="Type your answer..." autofocus />
                </div>
                <button type="submit">Continue</button>
              </form>
            `

            document.getElementById("inputForm").addEventListener("submit", async (e) => {
              e.preventDefault()
              const input = document.getElementById("simpleInput")
              const btn = e.target.querySelector("button")

              if (input.value.trim()) {
                btn.disabled = true
                btn.textContent = "Sending..."
                await submitResponse(req.requestId, input.value.trim())
              }
            })

            // Focus input
            document.getElementById("simpleInput")?.focus()
          }
          return
        }

        // Waiting for server
        content.innerHTML = `
          <span class="status-badge waiting">Waiting</span>
          <div class="waiting-state">
            <div class="icon">⏳</div>
            <div>Waiting for server workflow...</div>
            <div style="margin-top: 0.5rem; font-size: 0.9rem;">
              Make sure the server is running: <code>pnpm run workflow</code>
            </div>
          </div>
        `
      }

      init()
    </script>
  </body>
</html>
