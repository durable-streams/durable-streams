id: consumer-offset-handling
name: Offset Handling
description: Tests for offset edge cases and boundary conditions
category: consumer
tags:
  - core
  - offset
  - edge-cases

tests:
  - id: offset-minus-one-start
    name: Offset -1 reads from start
    description: Using offset -1 should read from the beginning of the stream
    setup:
      - action: create
        as: streamPath
      - action: append
        path: ${streamPath}
        data: "beginning"
      - action: append
        path: ${streamPath}
        data: "middle"
      - action: append
        path: ${streamPath}
        data: "end"
    operations:
      - action: read
        path: ${streamPath}
        offset: "-1"
        expect:
          data: "beginningmiddleend"

  - id: offset-now-skips-historical
    name: Offset 'now' skips historical data
    description: Using offset=now should return empty body with tail offset
    setup:
      - action: create
        as: streamPath
      - action: append
        path: ${streamPath}
        data: "historical"
      - action: append
        path: ${streamPath}
        data: "data"
    operations:
      - action: read
        path: ${streamPath}
        offset: "now"
        expect:
          chunkCount: 0
          upToDate: true
          storeOffsetAs: nowOffset
      # Verify we can resume from the offset
      - action: append
        path: ${streamPath}
        data: "future"
      - action: read
        path: ${streamPath}
        offset: ${nowOffset}
        expect:
          data: "future"

  - id: offset-now-empty-stream
    name: Offset 'now' on empty stream
    description: Using offset=now on an empty stream should work correctly
    setup:
      - action: create
        as: streamPath
    operations:
      - action: read
        path: ${streamPath}
        offset: "now"
        expect:
          chunkCount: 0
          upToDate: true
          storeOffsetAs: startOffset
      # Verify the offset works for future data
      - action: append
        path: ${streamPath}
        data: "firstdata"
      - action: read
        path: ${streamPath}
        offset: ${startOffset}
        expect:
          data: "firstdata"

  - id: offset-now-empty-stream-longpoll
    name: Offset 'now' on empty stream with long-poll
    description: Using offset=now with long-poll on an empty stream should wait for data
    requires:
      - longPoll
    setup:
      - action: create
        as: streamPath
    operations:
      # Long-poll with offset=now on empty stream should timeout
      - action: read
        path: ${streamPath}
        offset: "now"
        live: long-poll
        timeoutMs: 1000
        expect:
          status: 204
          upToDate: true
          storeOffsetAs: pollOffset
      # Verify the offset is valid and works for future data
      - action: append
        path: ${streamPath}
        data: "firstdata"
      - action: read
        path: ${streamPath}
        offset: ${pollOffset}
        expect:
          data: "firstdata"

  - id: offset-now-empty-stream-sse
    name: Offset 'now' on empty stream with SSE
    description: Using offset=now with SSE on an empty stream should provide valid offset
    requires:
      - sse
    setup:
      - action: create
        as: streamPath
    operations:
      # SSE with offset=now on empty stream
      - action: read
        path: ${streamPath}
        offset: "now"
        live: sse
        waitForUpToDate: true
        expect:
          chunkCount: 0
          upToDate: true
          storeOffsetAs: sseOffset
      # Verify the offset is valid and works for future data
      - action: append
        path: ${streamPath}
        data: "firstdata"
      - action: read
        path: ${streamPath}
        offset: ${sseOffset}
        expect:
          data: "firstdata"

  - id: offset-now-matches-tail
    name: Offset 'now' returns same offset as tail
    description: The offset from offset=now should match the stream tail offset
    setup:
      - action: create
        as: streamPath
      - action: append
        path: ${streamPath}
        data: "somedata"
    operations:
      # Get tail offset via normal read
      - action: read
        path: ${streamPath}
        expect:
          storeOffsetAs: tailOffset
      # Get offset via offset=now
      - action: read
        path: ${streamPath}
        offset: "now"
        expect:
          storeOffsetAs: nowOffset
      # Append and verify both offsets work identically
      - action: append
        path: ${streamPath}
        data: "newdata"
      - action: read
        path: ${streamPath}
        offset: ${tailOffset}
        expect:
          data: "newdata"
      - action: read
        path: ${streamPath}
        offset: ${nowOffset}
        expect:
          data: "newdata"

  - id: offset-now-longpoll-waits
    name: Offset 'now' with long-poll immediately waits for data
    description: Using offset=now with long-poll should immediately start waiting for new data (no round trip)
    setup:
      - action: create
        as: streamPath
      - action: append
        path: ${streamPath}
        data: "existingdata"
    operations:
      # Long-poll with offset=now should timeout with 204 since no new data arrives
      # This proves it immediately started waiting (skipping historical data)
      - action: read
        path: ${streamPath}
        offset: "now"
        live: long-poll
        timeoutMs: 1000
        expect:
          status: 204
          upToDate: true
          storeOffsetAs: pollOffset
      # Verify the offset works for future data
      - action: append
        path: ${streamPath}
        data: "afterpoll"
      - action: read
        path: ${streamPath}
        offset: ${pollOffset}
        expect:
          data: "afterpoll"

  - id: offset-now-sse
    name: Offset 'now' with SSE mode
    description: Using offset=now with SSE should skip historical data and provide correct offset
    requires:
      - sse
    setup:
      - action: create
        as: streamPath
      - action: append
        path: ${streamPath}
        data: "historicalsse"
    operations:
      - action: read
        path: ${streamPath}
        offset: "now"
        live: sse
        waitForUpToDate: true
        expect:
          chunkCount: 0
          storeOffsetAs: sseOffset
      # Verify offset works
      - action: append
        path: ${streamPath}
        data: "futuredata"
      - action: read
        path: ${streamPath}
        offset: ${sseOffset}
        expect:
          data: "futuredata"

  - id: offset-empty-stream
    name: Read from empty stream
    description: Reading from an empty stream should return no data and up-to-date
    setup:
      - action: create
        as: streamPath
    operations:
      - action: read
        path: ${streamPath}
        expect:
          chunkCount: 0
          upToDate: true

  - id: offset-at-end
    name: Read from end of stream
    description: Reading from the current end offset should return no new data
    setup:
      - action: create
        as: streamPath
      - action: append
        path: ${streamPath}
        data: "data"
        expect:
          storeOffsetAs: endOffset
    operations:
      - action: read
        path: ${streamPath}
        offset: ${endOffset}
        expect:
          chunkCount: 0
          upToDate: true

  - id: offset-resume-partial
    name: Resume read from middle offset
    description: Reading from a middle offset should only return subsequent data
    setup:
      - action: create
        as: streamPath
      - action: append
        path: ${streamPath}
        data: "part1"
        expect:
          storeOffsetAs: afterPart1
      - action: append
        path: ${streamPath}
        data: "part2"
        expect:
          storeOffsetAs: afterPart2
      - action: append
        path: ${streamPath}
        data: "part3"
    operations:
      # From afterPart1, should get part2 and part3
      - action: read
        path: ${streamPath}
        offset: ${afterPart1}
        expect:
          data: "part2part3"
      # From afterPart2, should only get part3
      - action: read
        path: ${streamPath}
        offset: ${afterPart2}
        expect:
          data: "part3"

  - id: offset-stored-correctly
    name: Stored offset can be used to resume
    description: Offsets stored from reads should work for resumption
    setup:
      - action: create
        as: streamPath
      - action: append
        path: ${streamPath}
        data: "chunk1"
      - action: append
        path: ${streamPath}
        data: "chunk2"
    operations:
      # First read stores the offset
      - action: read
        path: ${streamPath}
        expect:
          data: "chunk1chunk2"
          storeOffsetAs: resumeOffset
      # Append more data
      - action: append
        path: ${streamPath}
        data: "chunk3"
      # Resume from stored offset should only get new data
      - action: read
        path: ${streamPath}
        offset: ${resumeOffset}
        expect:
          data: "chunk3"

  - id: offset-longpoll-resume
    name: Long-poll respects offset for resumption
    description: Long-poll should only return data after the specified offset
    setup:
      - action: create
        as: streamPath
      - action: append
        path: ${streamPath}
        data: "old"
        expect:
          storeOffsetAs: oldOffset
      - action: append
        path: ${streamPath}
        data: "new"
    operations:
      - action: read
        path: ${streamPath}
        offset: ${oldOffset}
        live: long-poll
        timeoutMs: 1000
        expect:
          data: "new"
          upToDate: true

  - id: offset-sse-resume
    name: SSE respects offset for resumption
    description: SSE should only return data after the specified offset
    requires:
      - sse
    setup:
      - action: create
        as: streamPath
      - action: append
        path: ${streamPath}
        data: "old"
        expect:
          storeOffsetAs: oldOffset
      - action: append
        path: ${streamPath}
        data: "new"
    operations:
      - action: read
        path: ${streamPath}
        offset: ${oldOffset}
        live: sse
        waitForUpToDate: true
        expect:
          data: "new"

  - id: offset-multiple-reads-same-offset
    name: Multiple reads from same offset
    description: Reading from the same offset multiple times should return the same data
    setup:
      - action: create
        as: streamPath
      - action: append
        path: ${streamPath}
        data: "consistent"
        expect:
          storeOffsetAs: startOffset
      - action: append
        path: ${streamPath}
        data: "data"
    operations:
      # First read
      - action: read
        path: ${streamPath}
        offset: ${startOffset}
        expect:
          data: "data"
      # Second read from same offset should get same result
      - action: read
        path: ${streamPath}
        offset: ${startOffset}
        expect:
          data: "data"
      # Third read to confirm
      - action: read
        path: ${streamPath}
        offset: ${startOffset}
        expect:
          data: "data"
