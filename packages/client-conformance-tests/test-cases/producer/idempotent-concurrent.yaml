id: idempotent-concurrent
name: Idempotent Producer Concurrent Batches
description: Tests for client handling of 409 sequence gaps when HTTP requests arrive out of order
category: producer
tags:
  - idempotent
  - concurrent
  - retry

tests:
  - id: concurrent-batches-all-delivered
    name: All messages delivered with high concurrency
    description: |
      When using maxInFlight > 1, HTTP requests may arrive out of order causing 409 errors.
      The client should retry and ensure all messages are delivered.
    setup:
      - action: create
        as: streamPath
        contentType: text/plain
    operations:
      # Send 20 messages with maxInFlight=5
      # This forces concurrent batches that may arrive out of order
      - action: idempotent-append-batch
        path: ${streamPath}
        producerId: test-producer
        epoch: 0
        maxInFlight: 5
        items:
          - data: "msg-00"
          - data: "msg-01"
          - data: "msg-02"
          - data: "msg-03"
          - data: "msg-04"
          - data: "msg-05"
          - data: "msg-06"
          - data: "msg-07"
          - data: "msg-08"
          - data: "msg-09"
          - data: "msg-10"
          - data: "msg-11"
          - data: "msg-12"
          - data: "msg-13"
          - data: "msg-14"
          - data: "msg-15"
          - data: "msg-16"
          - data: "msg-17"
          - data: "msg-18"
          - data: "msg-19"
        expect:
          allSucceed: true
      # Verify all messages are in the stream
      - action: read
        path: ${streamPath}
        expect:
          dataContainsAll:
            - "msg-00"
            - "msg-05"
            - "msg-10"
            - "msg-15"
            - "msg-19"
          upToDate: true

  - id: concurrent-json-batches-all-delivered
    name: All JSON messages delivered with high concurrency
    description: Same test with JSON content type to verify JSON batching works with concurrency
    setup:
      - action: create
        as: streamPath
        contentType: application/json
    operations:
      - action: idempotent-append-batch
        path: ${streamPath}
        producerId: test-producer
        epoch: 0
        maxInFlight: 5
        items:
          - data: '{"id": 0}'
          - data: '{"id": 1}'
          - data: '{"id": 2}'
          - data: '{"id": 3}'
          - data: '{"id": 4}'
          - data: '{"id": 5}'
          - data: '{"id": 6}'
          - data: '{"id": 7}'
          - data: '{"id": 8}'
          - data: '{"id": 9}'
        expect:
          allSucceed: true
      - action: read
        path: ${streamPath}
        expect:
          dataContainsAll:
            - '"id":0'
            - '"id":5'
            - '"id":9'
          upToDate: true

  - id: autoclaim-with-pipelining
    name: autoClaim works with maxInFlight > 1
    description: |
      When autoClaim is true, the client should block pipelining until the first batch
      completes and the epoch is known. After that, full pipelining should be enabled.
      This test verifies that autoClaim + maxInFlight > 1 works correctly.
    setup:
      - action: create
        as: streamPath
        contentType: text/plain
    operations:
      # Send 20 messages with autoClaim=true and maxInFlight=5
      # The first batch should block until epoch is claimed, then pipelining kicks in
      - action: idempotent-append-batch
        path: ${streamPath}
        producerId: autoclaim-producer
        autoClaim: true
        maxInFlight: 5
        items:
          - data: "ac-00"
          - data: "ac-01"
          - data: "ac-02"
          - data: "ac-03"
          - data: "ac-04"
          - data: "ac-05"
          - data: "ac-06"
          - data: "ac-07"
          - data: "ac-08"
          - data: "ac-09"
          - data: "ac-10"
          - data: "ac-11"
          - data: "ac-12"
          - data: "ac-13"
          - data: "ac-14"
          - data: "ac-15"
          - data: "ac-16"
          - data: "ac-17"
          - data: "ac-18"
          - data: "ac-19"
        expect:
          allSucceed: true
      # Verify all messages are in the stream
      - action: read
        path: ${streamPath}
        expect:
          dataContainsAll:
            - "ac-00"
            - "ac-05"
            - "ac-10"
            - "ac-15"
            - "ac-19"
          upToDate: true

  - id: autoclaim-with-pipelining-json
    name: autoClaim with pipelining works for JSON streams
    description: Same test with JSON content type
    setup:
      - action: create
        as: streamPath
        contentType: application/json
    operations:
      - action: idempotent-append-batch
        path: ${streamPath}
        producerId: autoclaim-json-producer
        autoClaim: true
        maxInFlight: 5
        items:
          - data: '{"msg": 0}'
          - data: '{"msg": 1}'
          - data: '{"msg": 2}'
          - data: '{"msg": 3}'
          - data: '{"msg": 4}'
          - data: '{"msg": 5}'
          - data: '{"msg": 6}'
          - data: '{"msg": 7}'
          - data: '{"msg": 8}'
          - data: '{"msg": 9}'
        expect:
          allSucceed: true
      - action: read
        path: ${streamPath}
        expect:
          dataContainsAll:
            - '"msg":0'
            - '"msg":5'
            - '"msg":9'
          upToDate: true

  - id: autoclaim-recovers-from-stale-epoch
    name: autoClaim recovers when fenced by newer epoch
    description: |
      If a producer with autoClaim gets 403 (stale epoch) because another instance
      claimed a higher epoch, it should automatically bump its epoch and retry.
    setup:
      - action: create
        as: streamPath
        contentType: text/plain
    operations:
      # Establish epoch=5 via raw server-append (simulating another producer instance)
      - action: server-append
        path: ${streamPath}
        data: "from-epoch-5"
        producerId: recovery-producer
        producerEpoch: 5
        producerSeq: 0
        expect:
          status: 200
      # Client with autoClaim starts at epoch=0, should get 403 then recover with epoch=6
      - action: idempotent-append
        path: ${streamPath}
        producerId: recovery-producer
        epoch: 0
        autoClaim: true
        data: "recovered"
        expect:
          status: 200
      # Verify both messages are in the stream
      - action: read
        path: ${streamPath}
        expect:
          dataContainsAll:
            - "from-epoch-5"
            - "recovered"
          upToDate: true
